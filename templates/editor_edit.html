<!DOCTYPE html>
<html lang="kn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit News</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header class="topbar">
  <div class="logo">
    <h1>Edit News</h1>
  </div>
  <a href="/editor/dashboard" class="btn">Dashboard</a>
</header>

<div class="container">
  <div class="news-box">
    <h2>‡≤∏‡≥Å‡≤¶‡≥ç‡≤¶‡≤ø ‡≤∏‡≤Ç‡≤™‡≤æ‡≤¶‡≤®‡≥Ü</h2>

    <form method="post">
      <label>‡≤∂‡≥Ä‡≤∞‡≥ç‡≤∑‡≤ø‡≤ï‡≥Ü</label>
      <input type="text" name="title" required value="{{ item['title'] }}">

      <label>‡≤µ‡≤ø‡≤≠‡≤æ‡≤ó</label>
      <select name="category">
        <option {% if item['category']=='‡≤∏‡≥ç‡≤•‡≤≥‡≥Ä‡≤Ø' %}selected{% endif %}>‡≤∏‡≥ç‡≤•‡≤≥‡≥Ä‡≤Ø</option>
        <option {% if item['category']=='‡≤∞‡≤æ‡≤ú‡≤ï‡≥Ä‡≤Ø' %}selected{% endif %}>‡≤∞‡≤æ‡≤ú‡≤ï‡≥Ä‡≤Ø</option>
        <option {% if item['category']=='‡≤∞‡≥à‡≤§ ‡≤∏‡≥Å‡≤¶‡≥ç‡≤¶‡≤ø' %}selected{% endif %}>‡≤∞‡≥à‡≤§ ‡≤∏‡≥Å‡≤¶‡≥ç‡≤¶‡≤ø</option>
        <option {% if item['category']=='‡≤∂‡≤ø‡≤ï‡≥ç‡≤∑‡≤£' %}selected{% endif %}>‡≤∂‡≤ø‡≤ï‡≥ç‡≤∑‡≤£</option>
        <option {% if item['category']=='‡≤ï‡≥ç‡≤∞‡≥Ä‡≤°‡≥Ü' %}selected{% endif %}>‡≤ï‡≥ç‡≤∞‡≥Ä‡≤°‡≥Ü</option>
        <option {% if item['category']=='‡≤ß‡≤æ‡≤∞‡≥ç‡≤Æ‡≤ø‡≤ï' %}selected{% endif %}>‡≤ß‡≤æ‡≤∞‡≥ç‡≤Æ‡≤ø‡≤ï</option>
        <option {% if item['category']=='‡≤µ‡≤æ‡≤£‡≤ø‡≤ú‡≥ç‡≤Ø' %}selected{% endif %}>‡≤µ‡≤æ‡≤£‡≤ø‡≤ú‡≥ç‡≤Ø</option>
        <option {% if item['category']=='‡≤§‡≤æ‡≤≤‡≥ç‡≤≤‡≥Ç‡≤ï‡≤ø‡≤® ‡≤∏‡≥Å‡≤¶‡≥ç‡≤¶‡≤ø' %}selected{% endif %}>‡≤§‡≤æ‡≤≤‡≥ç‡≤≤‡≥Ç‡≤ï‡≤ø‡≤® ‡≤∏‡≥Å‡≤¶‡≥ç‡≤¶‡≤ø</option>
                                                                             
      </select>

      <label style="font-weight:bold;margin:12px 0;display:block;">
        <input type="checkbox" name="breaking" value="1" {% if item['breaking']==1 %}checked{% endif %}>
        ‚úÖ Breaking News ‡≤Ü‡≤ó‡≤ø ‡≤ó‡≥Å‡≤∞‡≥Å‡≤§‡≤ø‡≤∏‡≤ø
      </label>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin:12px 0;">
        <button type="button" class="btn" onclick="uploadImage()">üñº Upload Image</button>
        <button type="button" class="btn danger" onclick="uploadVideo()">üé• Upload Video</button>
      </div>

      <label>‡≤∏‡≥Å‡≤¶‡≥ç‡≤¶‡≤ø ‡≤µ‡≤ø‡≤µ‡≤∞</label>
      <textarea id="content" name="content">{{ item['content'] }}</textarea>

      <button class="btn" type="submit" style="margin-top:12px;">‚úÖ Update</button>
    </form>
  </div>
</div>

<script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>
<script>
  CKEDITOR.replace('content', { height: 420 });

  // ‚úÖ Upload to server (shows exact errors like 401, 413, 500)
  async function uploadToServer(file) {
    let data = new FormData();
    data.append("upload", file);

    let res;
    try {
      res = await fetch("/upload-media", { method: "POST", body: data });
    } catch (err) {
      alert("‚ùå Network error: " + err);
      return { uploaded: 0, error: { message: String(err) } };
    }

    // ‚úÖ show exact server error
    if (!res.ok) {
      const text = await res.text();
      alert("‚ùå Upload failed (" + res.status + "): " + text);
      return { uploaded: 0, error: { message: text } };
    }

    const json = await res.json();
    console.log("UPLOAD RESPONSE:", json);
    return json;
  }

  // ‚úÖ Upload Image
  async function uploadImage() {
    let input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";

    input.onchange = async function() {
      let file = input.files[0];
      if (!file) return;

      let json = await uploadToServer(file);

      if (json.uploaded) {
        CKEDITOR.instances.content.insertHtml(`
          <img src="${json.url}" style="width:100%;border-radius:12px;margin:10px 0;">
        `);
      } else {
        alert("‚ùå Image upload failed: " + (json.error?.message || ""));
      }
    };

    input.click();
  }

  // ‚úÖ Upload Video
  async function uploadVideo() {
    let input = document.createElement("input");
    input.type = "file";

    // ‚úÖ accept more formats (mobile videos often MOV/3GP)
    input.accept = "video/mp4,video/webm,video/ogg,video/quicktime,video/3gpp";

    input.onchange = async function() {
      let file = input.files[0];
      if (!file) return;

      let json = await uploadToServer(file);

      if (json.uploaded) {
        CKEDITOR.instances.content.insertHtml(`
          <div style="margin:10px 0;">
            <video controls playsinline style="width:100%;border-radius:12px;">
              <source src="${json.url}" type="${file.type || 'video/mp4'}">
              Your browser does not support the video tag.
            </video>
          </div>
        `);
      } else {
        alert("‚ùå Video upload failed: " + (json.error?.message || ""));
      }
    };

    input.click();
  }
</script>

</body>
</html>

